<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>PMAXPT - Pobieranie przez współrzędne</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Pobierz dane z IMGW PMAXTPAPI</h2>
  <form id="api-form">
    <label for="method">Metoda:</label>
    <select id="method" required>
      <option value="P">POT</option>
      <option value="A">AMP</option>
    </select><br><br>

    <label for="lat">Szerokość (lat):</label>
    <input type="number" id="lat" step="0.0001" required><br><br>

    <label for="lon">Długość (lon):</label>
    <input type="number" id="lon" step="0.0001" required><br><br>

    <button type="submit">Pobierz dane i zapisz jako XLSX</button>
  </form>

  <script>
    function formatCoordinate(value) {
      return parseFloat(value).toFixed(4);
    }

    function validateCoordinates(lat, lon) {
      if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert("Podano niepoprawne współrzędne geograficzne.");
        return false;
      }
      return true;
    }

    function buildPmaxtpUrl(method, lat, lon) {
      const baseUrl = "https://powietrze.imgw.pl/tpmax-api/point";
      return `${baseUrl}/${method}/KS/${formatCoordinate(lat)}/${formatCoordinate(lon)}`;
    }

    document.getElementById("api-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const method = document.getElementById("method").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);

      if (!validateCoordinates(lat, lon)) return;

      const url = buildPmaxtpUrl(method, lat, lon);
      console.log("Zapytanie do:", url);

      try {
        const response = await fetch(url, { cache: "no-store" });

        if (!response.ok) {
          throw new Error(`Błąd pobierania danych: ${response.status}`);
        }

        const data = await response.json();
        console.log("Odpowiedź API:", data);

        if (!data || !data.data) {
          alert("Brak danych do zapisania.");
          return;
        }

        const workbook = XLSX.utils.book_new();
        const regulationText = [
          ["REGULAMIN UDOSTĘPNIANIA DANYCH PROJEKTU PMAXTP"],
          ["Udostępnienie i korzystanie z danych dostępnych na stronach projektu PMAXTP następuje pod warunkiem wskazania źródła pochodzenia danych, w tym wskazania na monografię pt. „Modele probabilistyczne opadów maksymalnych o określonym czasie trwania i prawdopodobieństwie przewyższenia – Projekt PMAXTP” pod redakcją Bogdana Ozga-Zielińskiego, Instytut Meteorologii i Gospodarki Wodnej –  Państwowy Instytut Badawczy, Warszawa 2022  i ponadto podanie adresu strony internetowej projektu PMAXTP, poprzez umieszczenie przez korzystającego na wszelkiego rodzaju pracach lub produktach, opracowanych z użyciem danych IMGW-PIB informacji: „Źródłem pochodzenia danych jest Instytut Meteorologii i Gospodarki Wodnej – Państwowy Instytut Badawczy, dane pochodzą ze strony https://klimat.imgw.pl/opady-maksymalne”."],
          ["W przypadku przetworzenia przez korzystającego danych dostępnych na stronach projektu PMAXTP, obok wskazania źródła ich pochodzenia, jak w ust. 1, należy również wskazać na fakt przetworzenia ww. danych, poprzez umieszczenie przez korzystającego na wszelkiego rodzaju pracach lub produktach, opracowanych z użyciem przetworzonych danych IMGW-PIB informacji: „Dane Instytutu Meteorologii i Gospodarki Wodnej – Państwowego Instytutu Badawczego pochodzące ze strony https://klimat.imgw.pl/opady-maksymalne zostały przetworzone”"],
          ["Brak wskazania źródła danych, brak zamieszczenia informacji o przetworzeniu danych lub niedochowanie przez korzystającego innych obowiązków ciążących na korzystającym w związku z korzystaniem z danych, może skutkować odpowiedzialnością, w tym odpowiedzialnością karną, w szczególności na podstawie przepisów ustawy z dnia 4 lutego 1994 r. o prawie autorskim i prawach pokrewnych (Dz. U. z 2021 r. poz. 1062, z 2022 r. poz. 655) lub ustawy z dnia 30 czerwca 2011 r. prawo własności przemysłowej (Dz. U. z 2021 r. poz. 324)."],
          ["W zakresie udostępniania danych IMGW-PIB odpowiedzialny jest wyłącznie za przestrzeganie przepisów powszechnie obowiązującego prawa."],
          ["IMGW-PIB nie odpowiada za jakiekolwiek szkody, które nastąpiły w wyniku lub w związku z udostępnieniem, korzystaniem lub przetworzeniem danych. Korzystanie z danych następuje na wyłączne ryzyko i odpowiedzialność korzystającego."],
          ["Korzystanie z monografii, wraz z powołaniem się na nią jak w ust. 1, jest bezpłatne i odbywa się na zasadach Open Access, zgodnie z licencją: CC-BY 4.0. "]
        ];

        const categories = ["ks", "rb", "sg"];
        categories.forEach(category => {
        if (!data.data[category]) return;

        const firstEntry = Object.values(data.data[category])[0]; // Pierwszy obiekt w kategorii
        const keysOrder = Object.keys(firstEntry); // Klucze w ich naturalnej kolejności

        const sheetData = Object.entries(data.data[category]).map(([time, values]) => {
          const rowData = { "Czas trwania opadu (minuty)": time };
          keysOrder.forEach(key => {
            rowData[key] = values[key] ?? ""; // Uzupełniam dane bez zmian w kolejności
          });
          return rowData;
        });

        const worksheet = XLSX.utils.json_to_sheet(sheetData);
        // Dodanie pustego wiersza przed regulaminem
        XLSX.utils.sheet_add_aoa(worksheet, [[""]], { origin: -1 });
        XLSX.utils.sheet_add_aoa(worksheet, regulationText, { origin: -1 });
        XLSX.utils.book_append_sheet(workbook, worksheet, category.toUpperCase());
      });

        const fileName = `pmaxtp_${method}_${formatCoordinate(lat)}_${formatCoordinate(lon)}.xlsx`;
        XLSX.writeFile(workbook, fileName);
      } catch (error) {
        alert("Wystąpił błąd: " + error.message);
        console.error(error);
      }
    });
  </script>
</body>
</html>
