<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>PMAXTP - Pobieranie danych</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background-color: white;
      padding: 2rem 3rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
    }

    h2 {
      margin-top: 0;
      color: #333;
      text-align: center;
    }

    label {
      display: block;
      margin-top: 1rem;
      color: #555;
    }

    input, select, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #007BFF;
      color: white;
      border: none;
      margin-top: 1.5rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #0056b3;
    }

    .footer {
      margin-top: 2rem;
      font-size: 0.8rem;
      color: #999;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PMAXTP – Pobierz dane z IMGW</h2>
    <form id="api-form">
      <label for="method">Metoda:</label>
      <select id="method" required>
        <option value="P">POT</option>
        <option value="A">AMP</option>
      </select>

      <label for="lat">Szerokość geograficzna (lat):</label>
      <input type="number" id="lat" step="0.0001" required>

      <label for="lon">Długość geograficzna (lon):</label>
      <input type="number" id="lon" step="0.0001" required>

      <button type="submit">Pobierz i zapisz XLSX</button>
    </form>
    <div class="footer">
      <p style="text-align: justify;"></p>
      Źródłem pochodzenia danych jest Instytut Meteorologii i Gospodarki Wodnej – Państwowy Instytut Badawczy, 
      dane pochodzą ze strony https://klimat.imgw.pl/opady-maksymalne
      <br><br>
      "Modele probabilistyczne opadów maksymalnych o określonym czasie trwania i prawdopodobieństwie przewyższenia – Projekt PMAXTP”
       pod redakcją Bogdana Ozga-Zielińskiego, Instytut Meteorologii i Gospodarki Wodnej – Państwowy Instytut Badawczy, Warszawa 2022
      </p>
    </div>
  </div>

  <script>
    function formatCoordinate(value) {
      return parseFloat(value).toFixed(4);
    }

    function validateCoordinates(lat, lon) {
      if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert("Podano niepoprawne współrzędne geograficzne.");
        return false;
      }
      return true;
    }

    function buildPmaxtpUrl(method, lat, lon) {
      const baseUrl = "https://powietrze.imgw.pl/tpmax-api/point";
      return `${baseUrl}/${method}/KS/${formatCoordinate(lat)}/${formatCoordinate(lon)}`;
    }

    document.getElementById("api-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const method = document.getElementById("method").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);

      if (!validateCoordinates(lat, lon)) return;

      const url = buildPmaxtpUrl(method, lat, lon);
      console.log("Zapytanie do:", url);

      try {
        const response = await fetch(url, { cache: "no-store" });

        if (!response.ok) {
          throw new Error(`Błąd pobierania danych: ${response.status}`);
        }

        const data = await response.json();
        if (!data || !data.data) {
          alert("Brak danych do zapisania.");
          return;
        }

        const workbook = XLSX.utils.book_new();
        const regulationText = [
        ["REGULAMIN UDOSTĘPNIANIA DANYCH PROJEKTU PMAXTP"],
          ["Udostępnienie i korzystanie z danych dostępnych na stronach projektu PMAXTP następuje pod warunkiem wskazania źródła pochodzenia danych, w tym wskazania na monografię pt. „Modele probabilistyczne opadów maksymalnych o określonym czasie trwania i prawdopodobieństwie przewyższenia – Projekt PMAXTP” pod redakcją Bogdana Ozga-Zielińskiego, Instytut Meteorologii i Gospodarki Wodnej –  Państwowy Instytut Badawczy, Warszawa 2022  i ponadto podanie adresu strony internetowej projektu PMAXTP, poprzez umieszczenie przez korzystającego na wszelkiego rodzaju pracach lub produktach, opracowanych z użyciem danych IMGW-PIB informacji: „Źródłem pochodzenia danych jest Instytut Meteorologii i Gospodarki Wodnej – Państwowy Instytut Badawczy, dane pochodzą ze strony https://klimat.imgw.pl/opady-maksymalne”."],
          ["W przypadku przetworzenia przez korzystającego danych dostępnych na stronach projektu PMAXTP, obok wskazania źródła ich pochodzenia, jak w ust. 1, należy również wskazać na fakt przetworzenia ww. danych, poprzez umieszczenie przez korzystającego na wszelkiego rodzaju pracach lub produktach, opracowanych z użyciem przetworzonych danych IMGW-PIB informacji: „Dane Instytutu Meteorologii i Gospodarki Wodnej – Państwowego Instytutu Badawczego pochodzące ze strony https://klimat.imgw.pl/opady-maksymalne zostały przetworzone”"],
          ["Brak wskazania źródła danych, brak zamieszczenia informacji o przetworzeniu danych lub niedochowanie przez korzystającego innych obowiązków ciążących na korzystającym w związku z korzystaniem z danych, może skutkować odpowiedzialnością, w tym odpowiedzialnością karną, w szczególności na podstawie przepisów ustawy z dnia 4 lutego 1994 r. o prawie autorskim i prawach pokrewnych (Dz. U. z 2021 r. poz. 1062, z 2022 r. poz. 655) lub ustawy z dnia 30 czerwca 2011 r. prawo własności przemysłowej (Dz. U. z 2021 r. poz. 324)."],
          ["W zakresie udostępniania danych IMGW-PIB odpowiedzialny jest wyłącznie za przestrzeganie przepisów powszechnie obowiązującego prawa."],
          ["IMGW-PIB nie odpowiada za jakiekolwiek szkody, które nastąpiły w wyniku lub w związku z udostępnieniem, korzystaniem lub przetworzeniem danych. Korzystanie z danych następuje na wyłączne ryzyko i odpowiedzialność korzystającego."],
          ["Korzystanie z monografii, wraz z powołaniem się na nią jak w ust. 1, jest bezpłatne i odbywa się na zasadach Open Access, zgodnie z licencją: CC-BY 4.0. "]
        ];

        const categories = ["ks", "rb", "sg"];
        const sheetNames = {
          ks: "Kwantyle opadu",
          rb: "Błąd estymacji",
          sg: "GórnaGranicaUfności"
        };
        categories.forEach(category => {
          if (!data.data[category]) return;
          const firstEntry = Object.values(data.data[category])[0];
          const keysOrder = Object.keys(firstEntry).map(key => `${key}%`);
          const orderedKeys = ["Czas trwania (min)", ...keysOrder];

          const sheetData = Object.entries(data.data[category]).map(([time, values]) => {
            const row = { "Czas trwania (min)": time };
            keysOrder.forEach(key => {
              const originalKey = key.slice(0, -1);
              row[key] = values[originalKey] ?? "";
            });
            return row;
          });

          const worksheet = XLSX.utils.json_to_sheet(sheetData, { header: orderedKeys });
          XLSX.utils.sheet_add_aoa(worksheet, [[""]], { origin: -1 });
          XLSX.utils.sheet_add_aoa(worksheet, regulationText, { origin: -1 });
          XLSX.utils.book_append_sheet(workbook, worksheet, sheetNames[category]);
        });

        const fileName = `pmaxtp_${method}_${formatCoordinate(lat)}_${formatCoordinate(lon)}.xlsx`;
        XLSX.writeFile(workbook, fileName);
      } catch (error) {
        alert("Wystąpił błąd: " + error.message);
        console.error(error);
      }
    });
  </script>
</body>
</html>
